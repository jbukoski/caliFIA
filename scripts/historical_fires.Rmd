---
title: "Historical Fire"
author: "Jacob Bukoski"
date: "6/17/2020"
output: html_document
---

### Examining database that Jeremy sent

Historical fire data

```{r}

library(readxl)
library(RSQLite)
library(tidyverse)

filename <- "../data/TeamPotts1.db"
sqlite.driver <- dbDriver("SQLite")
db <- dbConnect(sqlite.driver, dbname = filename)

dbListTables(db)

db_COND_LB <- dbReadTable(db, "COND_LVL_LOOK_BACKS_PNW")
db_PLOT_LB <- dbReadTable(db, "PlotLevelFireDisturbPNWFromAnnualVisitLookbacks")

```

```{r}

# Jeremy's query

q1_jsf <- db_PLOT_LB %>%
  filter(ForestAtLastPostDistVisit == -1) %>%
  select(STATECD, PLOT_FIADB, DSTRBYR1) %>%
  group_by(STATECD, PLOT_FIADB) %>%
  mutate(n = n()) %>%    # This is the problematic line: should be n_distinct(DSTRBYR1) rather than n()
  #mutate(n = n_distinct(DSTRBYR1)) %>%
  filter(n >= 2)         # Without using n_distinct above, it counts multiple conditions and multiple fire types (e.g., n = 2 on plots with only one fire, but both dstrbcd 31 & 32 were recorded)

q2_jsf <- q1_jsf %>%
  select(STATECD, PLOT_FIADB, n) %>%
  group_by(STATECD) %>%
  summarise(n2 = n_distinct(PLOT_FIADB))

```

```{r}

all_dat <- db_PLOT_LB %>%
  left_join(db_COND_LB)

#---

q1 <- all_dat %>%
  filter(STATECD == 6, ForestAtLastPostDistVisit == -1) %>%
  select(STATECD, PLOT_FIADB, INVYR, DSTRBCD1, CONDID, DSTRBYR1, Source, ForestAtLastPostDistVisit) %>%
  group_by(PLOT_FIADB) %>%    # Group by additional criteria to better identify unique plots, some plots have 
  #mutate(n = n()) %>%
  mutate(n = n_distinct(DSTRBYR1)) %>%
  filter(n >= 2) %>%
  arrange(PLOT_FIADB, DSTRBYR1, INVYR)

length(unique(q1$PLOT_FIADB))

q2 <- q1 %>%
  group_by(PLOT_FIADB) %>%
  mutate(n2 = n_distinct(interaction(PLOT_FIADB, DSTRBYR1))) %>%
  filter(n2 >= 2) %>%
  select(-ForestAtLastPostDistVisit, -n) %>%
  mutate(TimeBtwnFires = max(DSTRBYR1) - min(DSTRBYR1))   # Calculate time between fires

n_distinct(q2$PLOT_FIADB)

# Need to handle 9999 plots
# Need to resolve plots with short times between fires

```

### Read in excel table with FIA plot and fire perimeter intersections

Columns:

- FireDisturbCodedOnPlot:
  - False: disturbance NOT coded for any condition at any visit under annual inventory
  - True: disturbance WAS coded but for a pre-1960 fire (SO, does not mean that a post-1960 disturbance was coded)

```{r}

intrsct_dat <- read_excel("../data/FireOverlay2.xlsx") %>%
  arrange(plot_fiadb, FireYear) %>%
  rename(PerimFireYear = FireYear)

```

```{r}

joined_dat <- q2 %>%
  left_join(intrsct_dat, by = c("PLOT_FIADB" = "plot_fiadb"), keep = T) %>%
  select(PLOT_FIADB, INVYR, DSTRBCD1, CONDID, DSTRBYR1, Source, TimeBtwnFires, PerimFireYear) %>%
  group_by(PLOT_FIADB) %>%
  mutate(match = DSTRBYR1 %in% PerimFireYear,
         n = n_distinct(match)) %>%
  group_by(PLOT_FIADB, CONDID) %>%
  mutate(n_FIAfires = n_distinct(DSTRBYR1),
         nPerimFires = n_distinct(PerimFireYear)) %>%
  ungroup()

rcnt_jnd_dat <- joined_dat %>%
  group_by(PLOT_FIADB) %>%
  filter(!any(DSTRBYR1 < 1960) && n_FIAfires == 2) %>%
  mutate(match = DSTRBYR1 %in% c(PerimFireYear, PerimFireYear - 1, PerimFireYear + 1, PerimFireYear - 2, PerimFireYear + 2),
         n = n_distinct(match)) %>%
  mutate(DstncBtwnFireYrs = abs(DSTRBYR1 - PerimFireYear)) %>%
  ungroup()
  

length(unique(rcnt_jnd_dat$PLOT_FIADB))

```

```{r}

confirmed <- rcnt_jnd_dat %>%
  filter(match == TRUE, n == 1) %>%
  mutate(DSTRBYR1 = ifelse(DstncBtwnFireYrs <= 2, PerimFireYear, DSTRBYR1)) %>%
  group_by(PLOT_FIADB) %>%
  mutate(n_FIAfires = n_distinct(DSTRBYR1)) %>%
  ungroup() %>%
  filter(match == TRUE, n == 1, n_FIAfires == 2)

prtly_cnfrmd <- rcnt_jnd_dat %>%
  filter(n == 2) %>%
  mutate(DSTRBYR1 = ifelse(DstncBtwnFireYrs <= 2, PerimFireYear, DSTRBYR1)) %>%
  group_by(PLOT_FIADB) %>%
  mutate(n_FIAfires = n_distinct(DSTRBYR1)) %>%
  ungroup() %>%
  filter(n == 2)

uncnfrmd <- rcnt_jnd_dat %>%
  filter(match == FALSE, n == 1)

length(unique(confirmed$PLOT_FIADB))
length(unique(prtly_cnfrmd$PLOT_FIADB))
length(unique(uncnfrmd$PLOT_FIADB))

```

Logical structure for inclusion/exlcusion of the various plots

Confirmed: Keep all confirmed plots!
Partly confirmed:
  If more than one 
  
```{r}

pass1 <- prtly_cnfrmd %>%
  mutate(keep = match)
  
p1 <- pass1 %>%
  group_by(PLOT_FIADB) %>%
  mutate(n_keep = n_distinct(keep)) %>%
  ungroup() %>%
  filter(keep == TRUE, n_keep == 1) %>%
  select(colnames(confirmed))
  
test <- add_row(confirmed, p1)

p2 <- pass1 %>%
  filter(!(PLOT_FIADB %in% p1$PLOT_FIADB))
  # Rule ii.
  group_by(PLOT_FIADB, DSTRBYR1) %>%
  mutate(dstnct_invyr = ifelse(keep == FALSE, n_distinct(INVYR), 0)) %>%
  mutate(keep = ifelse(dstnct_invyr >= 2, TRUE, keep)) %>%
  ungroup() %>%
  # Rule iii.
  group_by(PLOT_FIADB) %>%
  mutate(yr_dscrpncy = abs(DSTRBYR1  - PerimFireYear),
         ruleIII = ifelse(TimeBtwnFires < 2, TRUE, FALSE))



cln_prtly_cnfrmd %>%
  View()

```


### Plotting some of the numbers

```{r}

plt_dat <- q2 %>%
  filter(TimeBtwnFires <= 252)
  
plt_dat %>%
  select(PLOT_FIADB, TimeBtwnFires) %>%
  distinct() %>%
  pull(TimeBtwnFires) %>%
  hist(breaks = seq(0, 260, 10),
       main = "Histogram of time between fires for distinct plots")

```
