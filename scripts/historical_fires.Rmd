---
title: "Historical Fire"
author: "Jacob Bukoski"
date: "6/17/2020"
output: html_document
---

### Examining database that Jeremy sent

Historical fire data

```{r}

library(readxl)
library(RSQLite)
library(tidyverse)

filename <- "../data/TeamPotts1.db"
sqlite.driver <- dbDriver("SQLite")
db <- dbConnect(sqlite.driver, dbname = filename)

dbListTables(db)

db_COND_LB <- dbReadTable(db, "COND_LVL_LOOK_BACKS_PNW")
db_PLOT_LB <- dbReadTable(db, "PlotLevelFireDisturbPNWFromAnnualVisitLookbacks")

```

```{r}

all_dat <- db_PLOT_LB %>%
  left_join(db_COND_LB)

q1 <- all_dat %>%
  select(STATECD, PLOT_FIADB, INVYR, DSTRBCD1, CONDID, DSTRBYR1, ForestAtLastPostDistVisit) %>%
  filter(ForestAtLastPostDistVisit == -1, STATECD == 6) %>%
  group_by(PLOT_FIADB, DSTRBCD1, CONDID) %>%
  mutate(n = n()) %>%
  filter(n >= 2) %>%
  arrange(PLOT_FIADB, DSTRBYR1, INVYR) %>%
  ungroup()


q2 <- q1 %>%
  group_by(PLOT_FIADB, DSTRBCD1, CONDID) %>%
  mutate(n2 = n_distinct(interaction(PLOT_FIADB, DSTRBYR1))) %>%
  filter(n2 >= 2) %>%
  select(-ForestAtLastPostDistVisit, -n) %>%
  mutate(TimeBtwnFires = max(DSTRBYR1) - min(DSTRBYR1))

# Need to handle 9999 plots
# Need to resolve plots with short times between fires

```

### Plotting some of the numbers

```{r}

plt_dat <- q2 %>%
  filter(TimeBtwnFires <= 252)
  
plt_dat %>%
  select(PLOT_FIADB, TimeBtwnFires) %>%
  distinct() %>%
  pull(TimeBtwnFires) %>%
  hist(breaks = seq(0, 260, 10),
       main = "Histogram of time between fires for distinct plots")

```


### Read in excel table with FIA plot and fire perimeter intersections

Columns:

- FireDisturbCodedOnPlot:
  - False: disturbance NOT coded for any condition at any visit under annual inventory
  - True: disturbance WAS coded but for a pre-1960 fire (SO, does not mean that a post-1960 disturbance was coded)

```{r}

intrsct_dat <- read_excel("../data/FireOverlay2.xlsx") %>%
  arrange(plot_fiadb, FireYear) %>%
  rename(PerimFireYear = FireYear)

colnames(intrsct_dat)
```

```{r}

joined_dat <- q2 %>%
  left_join(intrsct_dat, by = c("PLOT_FIADB" = "plot_fiadb"), keep = T) %>%
  select(PLOT_FIADB, INVYR, DSTRBCD1, CONDID, DSTRBYR1, TimeBtwnFires, PerimFireYear) %>%
  group_by(PLOT_FIADB) %>%
  mutate(match = DSTRBYR1 %in% PerimFireYear,
         n = n_distinct(match))

```

```{r}

confirmed <- joined_dat %>%
  filter(match == TRUE, n == 1)

prtly_cnfrmd <- joined_dat %>%
  filter(n == 2)

uncnfrmd <- joined_dat %>%
  filter(match == FALSE, n == 1)

length(unique(confirmed$PLOT_FIADB))
length(unique(prtly_cnfrmd$PLOT_FIADB))
length(unique(uncnfrmd$PLOT_FIADB))

```

```{r}



```
